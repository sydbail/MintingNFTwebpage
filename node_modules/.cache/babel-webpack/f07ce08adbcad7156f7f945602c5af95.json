{"ast":null,"code":"const {\n  Buffer\n} = require('buffer');\n\nconst alloc = Buffer.alloc;\nconst ZEROS = '0000000000000000000';\nconst SEVENS = '7777777777777777777';\nconst ZERO_OFFSET = '0'.charCodeAt(0);\nconst USTAR_MAGIC = Buffer.from('ustar\\x00', 'binary');\nconst USTAR_VER = Buffer.from('00', 'binary');\nconst MASK = parseInt('7777', 8);\nconst MAGIC_OFFSET = 257;\nconst VERSION_OFFSET = 263;\n\nconst toTypeflag = function (flag) {\n  switch (flag) {\n    case 'file':\n      return 0;\n\n    case 'link':\n      return 1;\n\n    case 'symlink':\n      return 2;\n\n    case 'character-device':\n      return 3;\n\n    case 'block-device':\n      return 4;\n\n    case 'directory':\n      return 5;\n\n    case 'fifo':\n      return 6;\n\n    case 'contiguous-file':\n      return 7;\n\n    case 'pax-header':\n      return 72;\n  }\n\n  return 0;\n};\n\nconst cksum = function (block) {\n  let sum = 8 * 32;\n\n  for (let i = 0; i < 148; i++) sum += block[i];\n\n  for (let j = 156; j < 512; j++) sum += block[j];\n\n  return sum;\n};\n\nconst encodeOct = function (val, n) {\n  val = val.toString(8);\n  if (val.length > n) return SEVENS.slice(0, n) + ' ';else return ZEROS.slice(0, n - val.length) + val + ' ';\n};\n\nconst addLength = function (str) {\n  const len = Buffer.byteLength(str);\n  let digits = Math.floor(Math.log(len) / Math.log(10)) + 1;\n  if (len + digits >= Math.pow(10, digits)) digits++;\n  return len + digits + str;\n};\n\nexports.encodePax = function (opts) {\n  // TODO: encode more stuff in pax\n  let result = '';\n  if (opts.name) result += addLength(' path=' + opts.name + '\\n');\n  if (opts.linkname) result += addLength(' linkpath=' + opts.linkname + '\\n');\n  const pax = opts.pax;\n\n  if (pax) {\n    for (const key in pax) {\n      result += addLength(' ' + key + '=' + pax[key] + '\\n');\n    }\n  }\n\n  return Buffer.from(result);\n};\n\nexports.encode = function (opts) {\n  const buf = alloc(512);\n  let name = opts.name;\n  let prefix = '';\n  if (opts.typeflag === 5 && name[name.length - 1] !== '/') name += '/';\n  if (Buffer.byteLength(name) !== name.length) return null; // utf-8\n\n  while (Buffer.byteLength(name) > 100) {\n    const i = name.indexOf('/');\n    if (i === -1) return null;\n    prefix += prefix ? '/' + name.slice(0, i) : name.slice(0, i);\n    name = name.slice(i + 1);\n  }\n\n  if (Buffer.byteLength(name) > 100 || Buffer.byteLength(prefix) > 155) return null;\n  if (opts.linkname && Buffer.byteLength(opts.linkname) > 100) return null;\n  buf.write(name);\n  buf.write(encodeOct(opts.mode & MASK, 6), 100);\n  buf.write(encodeOct(opts.uid, 6), 108);\n  buf.write(encodeOct(opts.gid, 6), 116);\n  buf.write(encodeOct(opts.size, 11), 124);\n  buf.write(encodeOct(opts.mtime.getTime() / 1000 | 0, 11), 136);\n  buf[156] = ZERO_OFFSET + toTypeflag(opts.type);\n  if (opts.linkname) buf.write(opts.linkname, 157);\n  USTAR_MAGIC.copy(buf, MAGIC_OFFSET);\n  USTAR_VER.copy(buf, VERSION_OFFSET);\n  if (opts.uname) buf.write(opts.uname, 265);\n  if (opts.gname) buf.write(opts.gname, 297);\n  buf.write(encodeOct(opts.devmajor || 0, 6), 329);\n  buf.write(encodeOct(opts.devminor || 0, 6), 337);\n  if (prefix) buf.write(prefix, 345);\n  buf.write(encodeOct(cksum(buf), 6), 148);\n  return buf;\n};","map":null,"metadata":{},"sourceType":"script"}