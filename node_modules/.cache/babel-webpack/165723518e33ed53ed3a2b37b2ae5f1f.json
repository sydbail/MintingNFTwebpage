{"ast":null,"code":"'use strict'; // @ts-ignore nat-api does not export types\n\nvar _asyncToGenerator = require(\"/Users/sydneybailey/Internship/js-ipfs-examples/examples/browser-angular/node_modules/@babel/runtime/helpers/asyncToGenerator\").default;\n\nconst NatAPI = require('@motrix/nat-api');\n\nconst debug = require('debug');\n\nconst {\n  promisify\n} = require('es6-promisify');\n\nconst {\n  Multiaddr\n} = require('multiaddr');\n\nconst log = Object.assign(debug('libp2p:nat'), {\n  error: debug('libp2p:nat:err')\n});\n\nconst {\n  isBrowser\n} = require('wherearewe');\n\nconst retry = require('p-retry'); // @ts-ignore private-api does not export types\n\n\nconst isPrivateIp = require('private-ip');\n\nconst pkg = require('../package.json');\n\nconst errcode = require('err-code');\n\nconst {\n  codes: {\n    ERR_INVALID_PARAMETERS\n  }\n} = require('./errors');\n\nconst isLoopback = require('libp2p-utils/src/multiaddr/is-loopback');\n\nconst DEFAULT_TTL = 7200;\n/**\n * @typedef {import('peer-id')} PeerId\n * @typedef {import('./transport-manager')} TransportManager\n * @typedef {import('./address-manager')} AddressManager\n */\n\n/**\n * @typedef {Object} NatManagerProperties\n * @property {PeerId} peerId - The peer ID of the current node\n * @property {TransportManager} transportManager - A transport manager\n * @property {AddressManager} addressManager - An address manager\n *\n * @typedef {Object} NatManagerOptions\n * @property {boolean} enabled - Whether to enable the NAT manager\n * @property {string} [externalIp] - Pass a value to use instead of auto-detection\n * @property {string} [description] - A string value to use for the port mapping description on the gateway\n * @property {number} [ttl = DEFAULT_TTL] - How long UPnP port mappings should last for in seconds (minimum 1200)\n * @property {boolean} [keepAlive] - Whether to automatically refresh UPnP port mappings when their TTL is reached\n * @property {string} [gateway] - Pass a value to use instead of auto-detection\n * @property {object} [pmp] - PMP options\n * @property {boolean} [pmp.enabled] - Whether to enable PMP as well as UPnP\n */\n\nfunction highPort(min = 1024, max = 65535) {\n  return Math.floor(Math.random() * (max - min + 1) + min);\n}\n\nclass NatManager {\n  /**\n   * @class\n   * @param {NatManagerProperties & NatManagerOptions} options\n   */\n  constructor({\n    peerId,\n    addressManager,\n    transportManager,\n    ...options\n  }) {\n    this._peerId = peerId;\n    this._addressManager = addressManager;\n    this._transportManager = transportManager;\n    this._enabled = options.enabled;\n    this._externalIp = options.externalIp;\n    this._options = {\n      description: options.description || `${pkg.name}@${pkg.version} ${this._peerId}`,\n      ttl: options.ttl || DEFAULT_TTL,\n      autoUpdate: options.keepAlive || true,\n      gateway: options.gateway,\n      enablePMP: Boolean(options.pmp && options.pmp.enabled)\n    };\n\n    if (this._options.ttl < DEFAULT_TTL) {\n      throw errcode(new Error(`NatManager ttl should be at least ${DEFAULT_TTL} seconds`), ERR_INVALID_PARAMETERS);\n    }\n  }\n  /**\n   * Starts the NAT manager\n   */\n\n\n  start() {\n    if (isBrowser || !this._enabled) {\n      return;\n    } // done async to not slow down startup\n\n\n    this._start().catch(err => {\n      // hole punching errors are non-fatal\n      log.error(err);\n    });\n  }\n\n  _start() {\n    var _this = this;\n\n    return _asyncToGenerator(function* () {\n      const addrs = _this._transportManager.getAddrs();\n\n      for (const addr of addrs) {\n        // try to open uPnP ports for each thin waist address\n        const {\n          family,\n          host,\n          port,\n          transport\n        } = addr.toOptions();\n\n        if (!addr.isThinWaistAddress() || transport !== 'tcp') {\n          // only bare tcp addresses\n          // eslint-disable-next-line no-continue\n          continue;\n        }\n\n        if (isLoopback(addr)) {\n          // eslint-disable-next-line no-continue\n          continue;\n        }\n\n        if (family !== 4) {\n          // ignore ipv6\n          // eslint-disable-next-line no-continue\n          continue;\n        }\n\n        const client = _this._getClient();\n\n        const publicIp = _this._externalIp || (yield client.externalIp());\n\n        if (isPrivateIp(publicIp)) {\n          throw new Error(`${publicIp} is private - please set config.nat.externalIp to an externally routable IP or ensure you are not behind a double NAT`);\n        }\n\n        const publicPort = highPort();\n        log(`opening uPnP connection from ${publicIp}:${publicPort} to ${host}:${port}`);\n        yield client.map({\n          publicPort,\n          privatePort: port,\n          protocol: transport.toUpperCase()\n        });\n\n        _this._addressManager.addObservedAddr(Multiaddr.fromNodeAddress({\n          family: 4,\n          address: publicIp,\n          port: publicPort\n        }, transport));\n      }\n    })();\n  }\n\n  _getClient() {\n    if (this._client) {\n      return this._client;\n    }\n\n    const client = new NatAPI(this._options);\n    /** @type {(...any: any) => any} */\n\n    const map = promisify(client.map.bind(client));\n    /** @type {(...any: any) => any} */\n\n    const destroy = promisify(client.destroy.bind(client));\n    /** @type {(...any: any) => any} */\n\n    const externalIp = promisify(client.externalIp.bind(client)); // these are all network operations so add a retry\n\n    this._client = {\n      /**\n       * @param  {...any} args\n       * @returns {Promise<void>}\n       */\n      map: (...args) => retry(() => map(...args), {\n        onFailedAttempt: log.error,\n        unref: true\n      }),\n\n      /**\n       * @param  {...any} args\n       * @returns {Promise<void>}\n       */\n      destroy: (...args) => retry(() => destroy(...args), {\n        onFailedAttempt: log.error,\n        unref: true\n      }),\n\n      /**\n       * @param  {...any} args\n       * @returns {Promise<string>}\n       */\n      externalIp: (...args) => retry(() => externalIp(...args), {\n        onFailedAttempt: log.error,\n        unref: true\n      })\n    };\n    return this._client;\n  }\n  /**\n   * Stops the NAT manager\n   *\n   * @async\n   */\n\n\n  stop() {\n    var _this2 = this;\n\n    return _asyncToGenerator(function* () {\n      if (isBrowser || !_this2._client) {\n        return;\n      }\n\n      try {\n        yield _this2._client.destroy();\n        _this2._client = null;\n      } catch (err) {\n        log.error(err);\n      }\n    })();\n  }\n\n}\n\nmodule.exports = NatManager;","map":{"version":3,"sources":["/Users/sydneybailey/Internship/js-ipfs-examples/examples/browser-angular/node_modules/libp2p/src/nat-manager.js"],"names":["NatAPI","require","debug","promisify","Multiaddr","log","Object","assign","error","isBrowser","retry","isPrivateIp","pkg","errcode","codes","ERR_INVALID_PARAMETERS","isLoopback","DEFAULT_TTL","highPort","min","max","Math","floor","random","NatManager","constructor","peerId","addressManager","transportManager","options","_peerId","_addressManager","_transportManager","_enabled","enabled","_externalIp","externalIp","_options","description","name","version","ttl","autoUpdate","keepAlive","gateway","enablePMP","Boolean","pmp","Error","start","_start","catch","err","addrs","getAddrs","addr","family","host","port","transport","toOptions","isThinWaistAddress","client","_getClient","publicIp","publicPort","map","privatePort","protocol","toUpperCase","addObservedAddr","fromNodeAddress","address","_client","bind","destroy","args","onFailedAttempt","unref","stop","module","exports"],"mappings":"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","sourcesContent":["'use strict'\n\n// @ts-ignore nat-api does not export types\nconst NatAPI = require('@motrix/nat-api')\nconst debug = require('debug')\nconst { promisify } = require('es6-promisify')\nconst { Multiaddr } = require('multiaddr')\nconst log = Object.assign(debug('libp2p:nat'), {\n  error: debug('libp2p:nat:err')\n})\nconst { isBrowser } = require('wherearewe')\nconst retry = require('p-retry')\n// @ts-ignore private-api does not export types\nconst isPrivateIp = require('private-ip')\nconst pkg = require('../package.json')\nconst errcode = require('err-code')\nconst {\n  codes: { ERR_INVALID_PARAMETERS }\n} = require('./errors')\nconst isLoopback = require('libp2p-utils/src/multiaddr/is-loopback')\n\nconst DEFAULT_TTL = 7200\n\n/**\n * @typedef {import('peer-id')} PeerId\n * @typedef {import('./transport-manager')} TransportManager\n * @typedef {import('./address-manager')} AddressManager\n */\n\n/**\n * @typedef {Object} NatManagerProperties\n * @property {PeerId} peerId - The peer ID of the current node\n * @property {TransportManager} transportManager - A transport manager\n * @property {AddressManager} addressManager - An address manager\n *\n * @typedef {Object} NatManagerOptions\n * @property {boolean} enabled - Whether to enable the NAT manager\n * @property {string} [externalIp] - Pass a value to use instead of auto-detection\n * @property {string} [description] - A string value to use for the port mapping description on the gateway\n * @property {number} [ttl = DEFAULT_TTL] - How long UPnP port mappings should last for in seconds (minimum 1200)\n * @property {boolean} [keepAlive] - Whether to automatically refresh UPnP port mappings when their TTL is reached\n * @property {string} [gateway] - Pass a value to use instead of auto-detection\n * @property {object} [pmp] - PMP options\n * @property {boolean} [pmp.enabled] - Whether to enable PMP as well as UPnP\n */\n\nfunction highPort (min = 1024, max = 65535) {\n  return Math.floor(Math.random() * (max - min + 1) + min)\n}\n\nclass NatManager {\n  /**\n   * @class\n   * @param {NatManagerProperties & NatManagerOptions} options\n   */\n  constructor ({ peerId, addressManager, transportManager, ...options }) {\n    this._peerId = peerId\n    this._addressManager = addressManager\n    this._transportManager = transportManager\n\n    this._enabled = options.enabled\n    this._externalIp = options.externalIp\n    this._options = {\n      description: options.description || `${pkg.name}@${pkg.version} ${this._peerId}`,\n      ttl: options.ttl || DEFAULT_TTL,\n      autoUpdate: options.keepAlive || true,\n      gateway: options.gateway,\n      enablePMP: Boolean(options.pmp && options.pmp.enabled)\n    }\n\n    if (this._options.ttl < DEFAULT_TTL) {\n      throw errcode(new Error(`NatManager ttl should be at least ${DEFAULT_TTL} seconds`), ERR_INVALID_PARAMETERS)\n    }\n  }\n\n  /**\n   * Starts the NAT manager\n   */\n  start () {\n    if (isBrowser || !this._enabled) {\n      return\n    }\n\n    // done async to not slow down startup\n    this._start().catch((err) => {\n      // hole punching errors are non-fatal\n      log.error(err)\n    })\n  }\n\n  async _start () {\n    const addrs = this._transportManager.getAddrs()\n\n    for (const addr of addrs) {\n      // try to open uPnP ports for each thin waist address\n      const { family, host, port, transport } = addr.toOptions()\n\n      if (!addr.isThinWaistAddress() || transport !== 'tcp') {\n        // only bare tcp addresses\n        // eslint-disable-next-line no-continue\n        continue\n      }\n\n      if (isLoopback(addr)) {\n        // eslint-disable-next-line no-continue\n        continue\n      }\n\n      if (family !== 4) {\n        // ignore ipv6\n        // eslint-disable-next-line no-continue\n        continue\n      }\n\n      const client = this._getClient()\n      const publicIp = this._externalIp || await client.externalIp()\n\n      if (isPrivateIp(publicIp)) {\n        throw new Error(`${publicIp} is private - please set config.nat.externalIp to an externally routable IP or ensure you are not behind a double NAT`)\n      }\n\n      const publicPort = highPort()\n\n      log(`opening uPnP connection from ${publicIp}:${publicPort} to ${host}:${port}`)\n\n      await client.map({\n        publicPort,\n        privatePort: port,\n        protocol: transport.toUpperCase()\n      })\n\n      this._addressManager.addObservedAddr(Multiaddr.fromNodeAddress({\n        family: 4,\n        address: publicIp,\n        port: publicPort\n      }, transport))\n    }\n  }\n\n  _getClient () {\n    if (this._client) {\n      return this._client\n    }\n\n    const client = new NatAPI(this._options)\n\n    /** @type {(...any: any) => any} */\n    const map = promisify(client.map.bind(client))\n    /** @type {(...any: any) => any} */\n    const destroy = promisify(client.destroy.bind(client))\n    /** @type {(...any: any) => any} */\n    const externalIp = promisify(client.externalIp.bind(client))\n\n    // these are all network operations so add a retry\n    this._client = {\n      /**\n       * @param  {...any} args\n       * @returns {Promise<void>}\n       */\n      map: (...args) => retry(() => map(...args), { onFailedAttempt: log.error, unref: true }),\n\n      /**\n       * @param  {...any} args\n       * @returns {Promise<void>}\n       */\n      destroy: (...args) => retry(() => destroy(...args), { onFailedAttempt: log.error, unref: true }),\n\n      /**\n       * @param  {...any} args\n       * @returns {Promise<string>}\n       */\n      externalIp: (...args) => retry(() => externalIp(...args), { onFailedAttempt: log.error, unref: true })\n    }\n\n    return this._client\n  }\n\n  /**\n   * Stops the NAT manager\n   *\n   * @async\n   */\n  async stop () {\n    if (isBrowser || !this._client) {\n      return\n    }\n\n    try {\n      await this._client.destroy()\n      this._client = null\n    } catch (err) {\n      log.error(err)\n    }\n  }\n}\n\nmodule.exports = NatManager\n"]},"metadata":{},"sourceType":"script"}