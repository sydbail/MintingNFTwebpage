{"ast":null,"code":"'use strict';\n\nvar _asyncToGenerator = require(\"/Users/sydneybailey/Internship/Demo/node_modules/@babel/runtime/helpers/asyncToGenerator\").default;\n\nconst {\n  CID\n} = require('multiformats/cid');\n\nconst errcode = require('err-code');\n\nconst Message = require('../../message');\n\nconst utils = require('../../utils');\n/**\n * @typedef {import('peer-id')} PeerId\n */\n\n/**\n * @param {import('../../index')} dht\n */\n\n\nmodule.exports = dht => {\n  const log = utils.logger(dht.peerId, 'rpc:get-providers');\n  /**\n   * Process `GetProviders` DHT messages.\n   *\n   * @param {PeerId} peerId\n   * @param {Message} msg\n   */\n\n  function getProviders(_x, _x2) {\n    return _getProviders.apply(this, arguments);\n  }\n\n  function _getProviders() {\n    _getProviders = _asyncToGenerator(function* (peerId, msg) {\n      let cid;\n\n      try {\n        cid = CID.decode(msg.key);\n      } catch (err) {\n        throw errcode(new Error(`Invalid CID: ${err.message}`), 'ERR_INVALID_CID');\n      }\n\n      log('%s', cid.toString());\n      const dsKey = utils.bufferToKey(cid.bytes);\n      const [has, peers, closer] = yield Promise.all([dht.datastore.has(dsKey), dht.providers.getProviders(cid), dht._betterPeersToQuery(msg, peerId)]);\n      const providerPeers = peers.map(peerId => ({\n        id: peerId,\n        multiaddrs: []\n      }));\n      const closerPeers = closer.map(c => ({\n        id: c.id,\n        multiaddrs: []\n      }));\n\n      if (has) {\n        providerPeers.push({\n          id: dht.peerId,\n          multiaddrs: []\n        });\n      }\n\n      const response = new Message(msg.type, msg.key, msg.clusterLevel);\n\n      if (providerPeers.length > 0) {\n        response.providerPeers = providerPeers;\n      }\n\n      if (closerPeers.length > 0) {\n        response.closerPeers = closerPeers;\n      }\n\n      log('got %s providers %s closerPeers', providerPeers.length, closerPeers.length);\n      return response;\n    });\n    return _getProviders.apply(this, arguments);\n  }\n\n  return getProviders;\n};","map":{"version":3,"sources":["/Users/sydneybailey/Internship/Demo/node_modules/libp2p-kad-dht/src/rpc/handlers/get-providers.js"],"names":["CID","require","errcode","Message","utils","module","exports","dht","log","logger","peerId","getProviders","msg","cid","decode","key","err","Error","message","toString","dsKey","bufferToKey","bytes","has","peers","closer","Promise","all","datastore","providers","_betterPeersToQuery","providerPeers","map","id","multiaddrs","closerPeers","c","push","response","type","clusterLevel","length"],"mappings":"AAAA;;;;AAEA,MAAM;AAAEA,EAAAA;AAAF,IAAUC,OAAO,CAAC,kBAAD,CAAvB;;AACA,MAAMC,OAAO,GAAGD,OAAO,CAAC,UAAD,CAAvB;;AAEA,MAAME,OAAO,GAAGF,OAAO,CAAC,eAAD,CAAvB;;AACA,MAAMG,KAAK,GAAGH,OAAO,CAAC,aAAD,CAArB;AAEA;AACA;AACA;;AAEA;AACA;AACA;;;AACAI,MAAM,CAACC,OAAP,GAAkBC,GAAD,IAAS;AACxB,QAAMC,GAAG,GAAGJ,KAAK,CAACK,MAAN,CAAaF,GAAG,CAACG,MAAjB,EAAyB,mBAAzB,CAAZ;AAEA;AACF;AACA;AACA;AACA;AACA;;AAR0B,WASTC,YATS;AAAA;AAAA;;AAAA;AAAA,sCASxB,WAA6BD,MAA7B,EAAqCE,GAArC,EAA0C;AACxC,UAAIC,GAAJ;;AACA,UAAI;AACFA,QAAAA,GAAG,GAAGb,GAAG,CAACc,MAAJ,CAAWF,GAAG,CAACG,GAAf,CAAN;AACD,OAFD,CAEE,OAAOC,GAAP,EAAY;AACZ,cAAMd,OAAO,CAAC,IAAIe,KAAJ,CAAW,gBAAeD,GAAG,CAACE,OAAQ,EAAtC,CAAD,EAA2C,iBAA3C,CAAb;AACD;;AAEDV,MAAAA,GAAG,CAAC,IAAD,EAAOK,GAAG,CAACM,QAAJ,EAAP,CAAH;AACA,YAAMC,KAAK,GAAGhB,KAAK,CAACiB,WAAN,CAAkBR,GAAG,CAACS,KAAtB,CAAd;AAEA,YAAM,CAACC,GAAD,EAAMC,KAAN,EAAaC,MAAb,UAA6BC,OAAO,CAACC,GAAR,CAAY,CAC7CpB,GAAG,CAACqB,SAAJ,CAAcL,GAAd,CAAkBH,KAAlB,CAD6C,EAE7Cb,GAAG,CAACsB,SAAJ,CAAclB,YAAd,CAA2BE,GAA3B,CAF6C,EAG7CN,GAAG,CAACuB,mBAAJ,CAAwBlB,GAAxB,EAA6BF,MAA7B,CAH6C,CAAZ,CAAnC;AAMA,YAAMqB,aAAa,GAAGP,KAAK,CAACQ,GAAN,CAAWtB,MAAD,KAAa;AAC3CuB,QAAAA,EAAE,EAAEvB,MADuC;AAE3CwB,QAAAA,UAAU,EAAE;AAF+B,OAAb,CAAV,CAAtB;AAIA,YAAMC,WAAW,GAAGV,MAAM,CAACO,GAAP,CAAYI,CAAD,KAAQ;AACrCH,QAAAA,EAAE,EAAEG,CAAC,CAACH,EAD+B;AAErCC,QAAAA,UAAU,EAAE;AAFyB,OAAR,CAAX,CAApB;;AAKA,UAAIX,GAAJ,EAAS;AACPQ,QAAAA,aAAa,CAACM,IAAd,CAAmB;AACjBJ,UAAAA,EAAE,EAAE1B,GAAG,CAACG,MADS;AAEjBwB,UAAAA,UAAU,EAAE;AAFK,SAAnB;AAID;;AAED,YAAMI,QAAQ,GAAG,IAAInC,OAAJ,CAAYS,GAAG,CAAC2B,IAAhB,EAAsB3B,GAAG,CAACG,GAA1B,EAA+BH,GAAG,CAAC4B,YAAnC,CAAjB;;AAEA,UAAIT,aAAa,CAACU,MAAd,GAAuB,CAA3B,EAA8B;AAC5BH,QAAAA,QAAQ,CAACP,aAAT,GAAyBA,aAAzB;AACD;;AAED,UAAII,WAAW,CAACM,MAAZ,GAAqB,CAAzB,EAA4B;AAC1BH,QAAAA,QAAQ,CAACH,WAAT,GAAuBA,WAAvB;AACD;;AAED3B,MAAAA,GAAG,CAAC,iCAAD,EAAoCuB,aAAa,CAACU,MAAlD,EAA0DN,WAAW,CAACM,MAAtE,CAAH;AACA,aAAOH,QAAP;AACD,KAtDuB;AAAA;AAAA;;AAwDxB,SAAO3B,YAAP;AACD,CAzDD","sourcesContent":["'use strict'\n\nconst { CID } = require('multiformats/cid')\nconst errcode = require('err-code')\n\nconst Message = require('../../message')\nconst utils = require('../../utils')\n\n/**\n * @typedef {import('peer-id')} PeerId\n */\n\n/**\n * @param {import('../../index')} dht\n */\nmodule.exports = (dht) => {\n  const log = utils.logger(dht.peerId, 'rpc:get-providers')\n\n  /**\n   * Process `GetProviders` DHT messages.\n   *\n   * @param {PeerId} peerId\n   * @param {Message} msg\n   */\n  async function getProviders (peerId, msg) {\n    let cid\n    try {\n      cid = CID.decode(msg.key)\n    } catch (err) {\n      throw errcode(new Error(`Invalid CID: ${err.message}`), 'ERR_INVALID_CID')\n    }\n\n    log('%s', cid.toString())\n    const dsKey = utils.bufferToKey(cid.bytes)\n\n    const [has, peers, closer] = await Promise.all([\n      dht.datastore.has(dsKey),\n      dht.providers.getProviders(cid),\n      dht._betterPeersToQuery(msg, peerId)\n    ])\n\n    const providerPeers = peers.map((peerId) => ({\n      id: peerId,\n      multiaddrs: []\n    }))\n    const closerPeers = closer.map((c) => ({\n      id: c.id,\n      multiaddrs: []\n    }))\n\n    if (has) {\n      providerPeers.push({\n        id: dht.peerId,\n        multiaddrs: []\n      })\n    }\n\n    const response = new Message(msg.type, msg.key, msg.clusterLevel)\n\n    if (providerPeers.length > 0) {\n      response.providerPeers = providerPeers\n    }\n\n    if (closerPeers.length > 0) {\n      response.closerPeers = closerPeers\n    }\n\n    log('got %s providers %s closerPeers', providerPeers.length, closerPeers.length)\n    return response\n  }\n\n  return getProviders\n}\n"]},"metadata":{},"sourceType":"script"}