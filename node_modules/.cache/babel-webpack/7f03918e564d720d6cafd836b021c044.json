{"ast":null,"code":"'use strict';\n\nvar _asyncToGenerator = require(\"/Users/sydneybailey/Internship/js-ipfs-examples/examples/browser-angular/node_modules/@babel/runtime/helpers/asyncToGenerator\").default;\n\nconst mergeOptions = require('merge-options').bind({\n  ignoreUndefined: true\n});\n\nconst toMfsPath = require('./utils/to-mfs-path');\n\nconst log = require('debug')('ipfs:mfs:touch');\n\nconst errCode = require('err-code');\n\nconst {\n  UnixFS\n} = require('ipfs-unixfs');\n\nconst toTrail = require('./utils/to-trail');\n\nconst addLink = require('./utils/add-link');\n\nconst updateTree = require('./utils/update-tree');\n\nconst updateMfsRoot = require('./utils/update-mfs-root');\n\nconst dagPb = require('@ipld/dag-pb');\n\nconst {\n  CID\n} = require('multiformats/cid');\n\nconst withTimeoutOption = require('ipfs-core-utils/src/with-timeout-option');\n/**\n * @typedef {import('multiformats/cid').CIDVersion} CIDVersion\n * @typedef {import('ipfs-unixfs').MtimeLike} MtimeLike\n * @typedef {import('./').MfsContext} MfsContext\n * @typedef {object} DefaultOptions\n * @property {boolean} flush\n * @property {number} shardSplitThreshold\n * @property {CIDVersion} cidVersion\n * @property {string} hashAlg\n * @property {MtimeLike} [mtime]\n * @property {AbortSignal} [signal]\n * @property {number} [timeout]\n */\n\n/**\n * @type {DefaultOptions}\n */\n\n\nconst defaultOptions = {\n  flush: true,\n  shardSplitThreshold: 1000,\n  cidVersion: 0,\n  hashAlg: 'sha2-256'\n};\n/**\n * @param {MfsContext} context\n */\n\nmodule.exports = context => {\n  /**\n   * @type {import('ipfs-core-types/src/files').API[\"touch\"]}\n   */\n  function mfsTouch(_x) {\n    return _mfsTouch.apply(this, arguments);\n  }\n\n  function _mfsTouch() {\n    _mfsTouch = _asyncToGenerator(function* (path, options = {}) {\n      /** @type {DefaultOptions} */\n      const settings = mergeOptions(defaultOptions, options);\n      settings.mtime = settings.mtime || new Date();\n      log(`Touching ${path} mtime: ${settings.mtime}`);\n      const {\n        cid,\n        mfsDirectory,\n        name,\n        exists\n      } = yield toMfsPath(context, path, settings);\n      const hashAlg = options.hashAlg || defaultOptions.hashAlg;\n      const hasher = yield context.hashers.getHasher(hashAlg);\n      let updatedBlock;\n      let updatedCid;\n      let cidVersion = settings.cidVersion;\n\n      if (!exists) {\n        const metadata = new UnixFS({\n          type: 'file',\n          // @ts-ignore TODO: restore hrtime support to ipfs-unixfs constructor - it's in the code, just not the signature\n          mtime: settings.mtime\n        });\n        updatedBlock = dagPb.encode({\n          Data: metadata.marshal(),\n          Links: []\n        });\n        const hash = yield hasher.digest(updatedBlock);\n        updatedCid = CID.create(settings.cidVersion, dagPb.code, hash);\n\n        if (settings.flush) {\n          yield context.repo.blocks.put(updatedCid, updatedBlock);\n        }\n      } else {\n        if (cid.code !== dagPb.code) {\n          throw errCode(new Error(`${path} was not a UnixFS node`), 'ERR_NOT_UNIXFS');\n        }\n\n        cidVersion = cid.version;\n        const block = yield context.repo.blocks.get(cid);\n        const node = dagPb.decode(block);\n\n        if (!node.Data) {\n          throw errCode(new Error(`${path} had no data`), 'ERR_INVALID_NODE');\n        }\n\n        const metadata = UnixFS.unmarshal(node.Data); // @ts-ignore TODO: restore setting all date types as mtime - it's in the code, just not the signature\n\n        metadata.mtime = settings.mtime;\n        updatedBlock = dagPb.encode({\n          Data: metadata.marshal(),\n          Links: node.Links\n        });\n        const hash = yield hasher.digest(updatedBlock);\n        updatedCid = CID.create(settings.cidVersion, dagPb.code, hash);\n\n        if (settings.flush) {\n          yield context.repo.blocks.put(updatedCid, updatedBlock);\n        }\n      }\n\n      const trail = yield toTrail(context, mfsDirectory);\n      const parent = trail[trail.length - 1];\n      const parentCid = parent.cid;\n      const parentBlock = yield context.repo.blocks.get(parentCid);\n      const parentNode = dagPb.decode(parentBlock);\n      const result = yield addLink(context, {\n        parent: parentNode,\n        name: name,\n        cid: updatedCid,\n        size: updatedBlock.length,\n        flush: settings.flush,\n        shardSplitThreshold: settings.shardSplitThreshold,\n        hashAlg: settings.hashAlg,\n        cidVersion\n      });\n      parent.cid = result.cid; // update the tree with the new child\n\n      const newRootCid = yield updateTree(context, trail, settings); // Update the MFS record with the new CID for the root of the tree\n\n      yield updateMfsRoot(context, newRootCid, settings);\n    });\n    return _mfsTouch.apply(this, arguments);\n  }\n\n  return withTimeoutOption(mfsTouch);\n};","map":{"version":3,"sources":["/Users/sydneybailey/Internship/js-ipfs-examples/examples/browser-angular/node_modules/ipfs-core/src/components/files/touch.js"],"names":["mergeOptions","require","bind","ignoreUndefined","toMfsPath","log","errCode","UnixFS","toTrail","addLink","updateTree","updateMfsRoot","dagPb","CID","withTimeoutOption","defaultOptions","flush","shardSplitThreshold","cidVersion","hashAlg","module","exports","context","mfsTouch","path","options","settings","mtime","Date","cid","mfsDirectory","name","exists","hasher","hashers","getHasher","updatedBlock","updatedCid","metadata","type","encode","Data","marshal","Links","hash","digest","create","code","repo","blocks","put","Error","version","block","get","node","decode","unmarshal","trail","parent","length","parentCid","parentBlock","parentNode","result","size","newRootCid"],"mappings":"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","sourcesContent":["'use strict'\n\nconst mergeOptions = require('merge-options').bind({ ignoreUndefined: true })\nconst toMfsPath = require('./utils/to-mfs-path')\nconst log = require('debug')('ipfs:mfs:touch')\nconst errCode = require('err-code')\nconst { UnixFS } = require('ipfs-unixfs')\nconst toTrail = require('./utils/to-trail')\nconst addLink = require('./utils/add-link')\nconst updateTree = require('./utils/update-tree')\nconst updateMfsRoot = require('./utils/update-mfs-root')\nconst dagPb = require('@ipld/dag-pb')\nconst { CID } = require('multiformats/cid')\nconst withTimeoutOption = require('ipfs-core-utils/src/with-timeout-option')\n\n/**\n * @typedef {import('multiformats/cid').CIDVersion} CIDVersion\n * @typedef {import('ipfs-unixfs').MtimeLike} MtimeLike\n * @typedef {import('./').MfsContext} MfsContext\n * @typedef {object} DefaultOptions\n * @property {boolean} flush\n * @property {number} shardSplitThreshold\n * @property {CIDVersion} cidVersion\n * @property {string} hashAlg\n * @property {MtimeLike} [mtime]\n * @property {AbortSignal} [signal]\n * @property {number} [timeout]\n */\n\n/**\n * @type {DefaultOptions}\n */\nconst defaultOptions = {\n  flush: true,\n  shardSplitThreshold: 1000,\n  cidVersion: 0,\n  hashAlg: 'sha2-256'\n}\n\n/**\n * @param {MfsContext} context\n */\nmodule.exports = (context) => {\n  /**\n   * @type {import('ipfs-core-types/src/files').API[\"touch\"]}\n   */\n  async function mfsTouch (path, options = {}) {\n    /** @type {DefaultOptions} */\n    const settings = mergeOptions(defaultOptions, options)\n    settings.mtime = settings.mtime || new Date()\n\n    log(`Touching ${path} mtime: ${settings.mtime}`)\n\n    const {\n      cid,\n      mfsDirectory,\n      name,\n      exists\n    } = await toMfsPath(context, path, settings)\n\n    const hashAlg = options.hashAlg || defaultOptions.hashAlg\n    const hasher = await context.hashers.getHasher(hashAlg)\n\n    let updatedBlock\n    let updatedCid\n\n    let cidVersion = settings.cidVersion\n\n    if (!exists) {\n      const metadata = new UnixFS({\n        type: 'file',\n        // @ts-ignore TODO: restore hrtime support to ipfs-unixfs constructor - it's in the code, just not the signature\n        mtime: settings.mtime\n      })\n      updatedBlock = dagPb.encode({ Data: metadata.marshal(), Links: [] })\n\n      const hash = await hasher.digest(updatedBlock)\n\n      updatedCid = CID.create(settings.cidVersion, dagPb.code, hash)\n\n      if (settings.flush) {\n        await context.repo.blocks.put(updatedCid, updatedBlock)\n      }\n    } else {\n      if (cid.code !== dagPb.code) {\n        throw errCode(new Error(`${path} was not a UnixFS node`), 'ERR_NOT_UNIXFS')\n      }\n\n      cidVersion = cid.version\n\n      const block = await context.repo.blocks.get(cid)\n      const node = dagPb.decode(block)\n\n      if (!node.Data) {\n        throw errCode(new Error(`${path} had no data`), 'ERR_INVALID_NODE')\n      }\n\n      const metadata = UnixFS.unmarshal(node.Data)\n\n      // @ts-ignore TODO: restore setting all date types as mtime - it's in the code, just not the signature\n      metadata.mtime = settings.mtime\n\n      updatedBlock = dagPb.encode({\n        Data: metadata.marshal(),\n        Links: node.Links\n      })\n\n      const hash = await hasher.digest(updatedBlock)\n      updatedCid = CID.create(settings.cidVersion, dagPb.code, hash)\n\n      if (settings.flush) {\n        await context.repo.blocks.put(updatedCid, updatedBlock)\n      }\n    }\n\n    const trail = await toTrail(context, mfsDirectory)\n    const parent = trail[trail.length - 1]\n    const parentCid = parent.cid\n    const parentBlock = await context.repo.blocks.get(parentCid)\n    const parentNode = dagPb.decode(parentBlock)\n\n    const result = await addLink(context, {\n      parent: parentNode,\n      name: name,\n      cid: updatedCid,\n      size: updatedBlock.length,\n      flush: settings.flush,\n      shardSplitThreshold: settings.shardSplitThreshold,\n      hashAlg: settings.hashAlg,\n      cidVersion\n    })\n\n    parent.cid = result.cid\n\n    // update the tree with the new child\n    const newRootCid = await updateTree(context, trail, settings)\n\n    // Update the MFS record with the new CID for the root of the tree\n    await updateMfsRoot(context, newRootCid, settings)\n  }\n\n  return withTimeoutOption(mfsTouch)\n}\n"]},"metadata":{},"sourceType":"script"}